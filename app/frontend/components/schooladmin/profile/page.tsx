"use client";

import { useEffect, useState } from "react";
import { AcademicPerformance } from "./components/AcademicPerformance";
import { FeeTransactions } from "./components/FeeTransactions";
import { ProfileSidebar } from "./components/ProfileSidebar";
import { AttendanceTrends } from "./components/AttendanceTrends";
import { Certificates } from "./components/Certificates";
import { Calendar, BookOpen, Activity, Clock } from "lucide-react";
import PageHeader from "../../common/PageHeader";

type StudentDetail = {
  student: {
    id: string;
    name: string;
    admissionNumber: string;
    email: string;
    photoUrl?: string | null;
    rollNo: string;
    age: number | null;
    address: string;
    phone: string;
    fatherName: string;
    motherName?: string;
    fatherOccupation?: string;
    motherOccupation?: string;
    fatherPhone?: string;
    class: { id: string; name: string; section: string | null; displayName: string } | null;
  };
  fee: {
    totalFee: number;
    amountPaid: number;
    remainingFee: number;
    moneyForStudent: number | null;
  } | null;
  payments: Array<{
    id: string;
    amount: number;
    status: string;
    method: string;
    createdAt: string;
    transactionId: string | null;
  }>;
  attendanceTrends: Array<{ month: string; present: number; total: number; pct: number }>;
  academicPerformance: Array<{ subject: string; score: number }>;
  certificates: Array<{
    id: string;
    title: string;
    issuedDate: string;
    issuedBy: string | null;
    certificateUrl: string | null;
  }>;
};

type StudentOption = {
  id: string;
  name: string;
  admissionNumber: string;
  classDisplay: string;
  classId: string;
  section: string | null;
};

export default function StudentDetailsPage() {
  const [students, setStudents] = useState<StudentOption[]>([]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [detail, setDetail] = useState<StudentDetail | null>(null);
  const [loading, setLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [filterClass, setFilterClass] = useState("");
  const [filterSection, setFilterSection] = useState("");
  const [classes, setClasses] = useState<{ id: string; name: string; section: string | null }[]>([]);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        const [studentsRes, classesRes] = await Promise.all([
          fetch("/api/student/list", { credentials: "include" }),
          fetch("/api/class/list", { credentials: "include" }),
        ]);
        if (!cancelled && studentsRes.ok) {
          const d = await studentsRes.json();
          const list: StudentOption[] = (d.students || []).map((s: { id: string; user?: { name?: string }; admissionNumber?: string; class?: { id: string; name: string; section: string | null } }) => ({
            id: s.id,
            name: s.user?.name ?? "Unknown",
            admissionNumber: s.admissionNumber ?? "",
            classDisplay: s.class ? `${s.class.name}${s.class.section ? `-${s.class.section}` : ""}` : "-",
            classId: s.class?.id ?? "",
            section: s.class?.section ?? null,
          }));
          setStudents(list);
          if (list.length > 0 && !selectedId) setSelectedId(list[0].id);
        }
        if (!cancelled && classesRes.ok) {
          const c = await classesRes.json();
          setClasses(c.classes ?? []);
        }
      } catch {
        if (!cancelled) setStudents([]);
      }
    })();
    return () => { cancelled = true; };
  }, []);

  useEffect(() => {
    if (!selectedId) {
      setDetail(null);
      return;
    }
    let cancelled = false;
    setLoading(true);
    fetch(`/api/student/${selectedId}`, { credentials: "include" })
      .then((r) => r.json())
      .then((d) => {
        if (!cancelled && d?.student) {
          setDetail(d);
        } else {
          setDetail(null);
        }
      })
      .catch(() => {
        if (!cancelled) setDetail(null);
      })
      .finally(() => {
        if (!cancelled) setLoading(false);
      });
    return () => { cancelled = true; };
  }, [selectedId]);

  const filtered = students.filter((s) => {
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      if (!s.name.toLowerCase().includes(q) && !s.admissionNumber.toLowerCase().includes(q)) return false;
    }
    if (filterClass && s.classId !== filterClass) return false;
    if (filterSection && s.section !== filterSection) return false;
    return true;
  });

  const selectedOption = filtered.find((s) => s.id === selectedId) ?? filtered[0];
  const classOptions = [{ label: "All Classes", value: "" }, ...classes.map((c) => ({ label: `${c.name}${c.section ? ` - ${c.section}` : ""}`, value: c.id }))];
  const sections = Array.from(new Set(classes.map((c) => c.section).filter(Boolean))) as string[];
  const sectionOptions = [{ label: "All Sections", value: "" }, ...sections.map((s) => ({ label: s, value: s }))];

  return (
    <div className="p-2 sm:p-6 md:p-8 space-y-6 md:space-y-8 max-w-[1600px] mx-auto min-h-0 overflow-y-auto overflow-x-hidden pb-8">
      <PageHeader
        title="Student Details"
        subtitle="View comprehensive academic and personal records."
        rightSlot={
          <div className="bg-[#0F172A]/40 border border-white/10 px-4 py-2 rounded-xl text-sm text-gray-200">
            {new Date().getFullYear() - 1}-{new Date().getFullYear()}
          </div>
        }
      />


      <div className="bg-white/5 backdrop-blur-xl border-b border-white/10 rounded-2xl p-4 sm:p-6 grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
        <div>
          <label className="text-xs text-gray-500 mb-2 block">Search Student</label>
          <div className="relative">
            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîç</span>
            <input
              type="text"
              placeholder="Search by name or ID..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full bg-[#0F172A]/40 border border-white/10 rounded-xl pl-10 pr-4 py-2.5 sm:py-2 text-sm outline-none text-gray-200 min-h-[44px] touch-manipulation"
            />
          </div>
        </div>
        <div>
          <label className="text-xs text-gray-500 mb-2 block">Filter by Class</label>
          <select
            value={filterClass}
            onChange={(e) => setFilterClass(e.target.value)}
            className="w-full bg-[#0F172A]/40 border border-white/10 rounded-xl px-4 py-2.5 sm:py-2 text-sm outline-none text-gray-200 min-h-[44px] touch-manipulation"
          >
            {classOptions.map((o) => (
              <option key={o.value} value={o.value}>{o.label}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="text-xs text-gray-500 mb-2 block">Filter by Section</label>
          <select
            value={filterSection}
            onChange={(e) => setFilterSection(e.target.value)}
            className="w-full bg-[#0F172A]/40 border border-white/10 rounded-xl px-4 py-2.5 sm:py-2 text-sm outline-none text-gray-200 min-h-[44px] touch-manipulation"
          >
            {sectionOptions.map((o) => (
              <option key={o.value} value={o.value}>{o.label}</option>
            ))}
          </select>
        </div>
        <div className="md:col-span-3">
          <label className="text-xs text-gray-500 mb-2 block">Select Student Profile</label>
          <select
            value={selectedId ?? ""}
            onChange={(e) => setSelectedId(e.target.value || null)}
            className="w-full bg-lime-400/10 border border-lime-400/40 rounded-xl px-4 py-2.5 sm:py-2 text-sm outline-none text-gray-200 min-h-[44px] touch-manipulation"
          >
            {filtered.map((s) => (
              <option key={s.id} value={s.id}>
                {s.name} ({s.admissionNumber}) - Class {s.classDisplay}
              </option>
            ))}
          </select>
        </div>
      </div>

      {loading && (
        <div className="text-center py-12 text-gray-400">Loading student details...</div>
      )}

      {!loading && detail && (
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 md:gap-8 min-w-0">
          <div className="lg:col-span-1">
            <ProfileSidebar
              student={{
                name: detail.student.name,
                id: detail.student.admissionNumber,
                className: detail.student.class?.displayName ?? "-",
                rollNo: detail.student.rollNo,
                age: String(detail.student.age ?? "-"),
                email: detail.student.email,
                phone: detail.student.phone,
                address: detail.student.address || "‚Äî",
                photoUrl: detail.student.photoUrl ?? undefined,
              }}
              fatherName={detail.student.fatherName}
              fatherOccupation={detail.student.fatherOccupation}
              fatherPhone={detail.student.fatherPhone}
              motherName={detail.student.motherName}
              motherOccupation={detail.student.motherOccupation}
            />
          </div>

          <div className="lg:col-span-3 space-y-6 md:space-y-8">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
              <div className="bg-white/5 backdrop-blur-xl border-b border-white/10 rounded-2xl p-3 sm:p-4 flex items-center gap-3 sm:gap-4 min-w-0">
                <div className="p-2 bg-lime-400/10 rounded-xl flex-shrink-0">
                  <Calendar className="w-5 h-5 sm:w-5 sm:h-5 text-lime-400" />
                </div>
                <div className="min-w-0">
                  <p className="text-[10px] sm:text-xs text-gray-500">Attendance</p>
                  <p className="text-base sm:text-lg font-bold text-white truncate">
                    {detail.attendanceTrends.length
                      ? `${Math.round(detail.attendanceTrends.reduce((a, t) => a + t.pct, 0) / detail.attendanceTrends.length)}%`
                      : "-"}
                  </p>
                  <p className="text-[10px] text-lime-400">Avg this year</p>
                </div>
              </div>
              <div className="bg-white/5 backdrop-blur-xl border-b border-white/10 rounded-2xl p-3 sm:p-4 flex items-center gap-3 sm:gap-4 min-w-0">
                <div className="p-2 text-white rounded-xl flex-shrink-0">
                  <BookOpen className="w-5 h-5 text-blue-400" />
                </div>
                <div>
                  <p className="text-xs text-gray-500">Avg Grade</p>
                  <p className="text-lg font-bold text-white">
                    {detail.academicPerformance.length ? "A" : "-"}
                  </p>
                  <p className="text-[10px] text-blue-400">Academic Rank: ‚Äî</p>
                </div>
              </div>
              <div className="bg-white/5 backdrop-blur-xl border-b border-white/10 rounded-2xl p-3 sm:p-4 flex items-center gap-3 sm:gap-4 min-w-0">
                <div className="p-2 bg-pink-400/10 rounded-xl flex-shrink-0">
                  <Activity className="w-5 h-5 text-pink-400" />
                </div>
                <div>
                  <p className="text-xs text-gray-500">Behavior</p>
                  <p className="text-lg font-bold text-pink-400">‚Äî</p>
                  <p className="text-[10px] text-pink-400">‚Äî</p>
                </div>
              </div>
              <div className="bg-white/5 backdrop-blur-xl border-b border-white/10 rounded-2xl p-3 sm:p-4 flex items-center gap-3 sm:gap-4 min-w-0">
                <div className="p-2 bg-amber-400/10 rounded-xl flex-shrink-0">
                  <Clock className="w-5 h-5 text-amber-400" />
                </div>
                <div>
                  <p className="text-xs text-gray-500">Fees Due</p>
                  <p className="text-lg font-bold text-lime-400">
                    {detail.fee && detail.fee.remainingFee > 0
                      ? `‚Çπ${detail.fee.remainingFee.toLocaleString()}`
                      : "‚Çπ0"}
                  </p>
                  <p className="text-[10px] text-lime-400">
                    {detail.fee && detail.fee.remainingFee <= 0 ? "All Cleared" : "Pending"}
                  </p>
                </div>
              </div>
            </div>

            <AcademicPerformance data={detail.academicPerformance} />
           
             <AttendanceTrends data={detail.attendanceTrends} />
              <FeeTransactions
                fee={detail.fee}
                payments={detail.payments}
              />
            <Certificates certificates={detail.certificates} />
          </div>
        </div>
      )}

      {!loading && !detail && selectedId && (
        <div className="text-center py-12 text-gray-400">Student not found.</div>
      )}

      {!loading && !selectedId && students.length === 0 && (
        <div className="text-center py-12 text-gray-400">No students found.</div>
      )}
    </div>
  );
}
